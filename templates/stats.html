<!DOCTYPE html>
<html>
<head>
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ {{ link_id }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="container">
        <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {{ link_id }}</h1>
        
        <div class="section">
            <h2>üîó –í–∞—à–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–∞—è —Å—Å—ã–ª–∫–∞</h2>
            <div class="tracking-link-box">
                <input type="text" id="trackingUrl" value="{{ tracking_url }}" readonly>
                <button onclick="copyToClipboard()" class="btn-copy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <p class="hint">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–æ–π —Å—Å—ã–ª–∫–æ–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</p>
        </div>

        <div class="section">
            <h2>üìà –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <a href="/export/{{ link_id }}/csv" class="btn-export">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</a>
            <div class="stats-grid">
                <div class="stat-box total-clicks">
                    <h3>–í—Å–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</h3>
                    <p>{{ stats[0][0] if stats else 0 }}</p>
                </div>
                <div class="stat-box unique-visitors">
                    <h3>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</h3>
                    <p>{{ stats[0][1] if stats else 0 }}</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</h2>
            <div id="map"></div>
            <p class="hint">–¢–æ—á–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏</p>
        </div>

        <div class="section">
            <h2>üïí –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>–í—Ä–µ–º—è</th>
                            <th>IP</th>
                            <th>–°—Ç—Ä–∞–Ω–∞</th>
                            <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
                            <th>–ë—Ä–∞—É–∑–µ—Ä</th>
                            <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr>
                            <td>{{ log[9] }}</td>
                            <td>{{ log[2] }}</td>
                            <td>{{ log[3] }}</td>
                            <td>{{ log[4] }}</td>
                            <td>{{ log[5] }}</td>
                            <td>
                                {% if log[7] and log[8] %}
                                    {{ "%.4f, %.4f"|format(log[7], log[8]) }}
                                {% else %}
                                    –ù/–î
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU" 
            type="text/javascript"></script>
    <script>
    function copyToClipboard() {
        const copyText = document.getElementById("trackingUrl");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        document.execCommand("copy");
        alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: " + copyText.value);
    }

    ymaps.ready(initMap);

    function initMap() {
        try {
            const map = new ymaps.Map('map', {
                center: [55.751574, 37.573856],
                zoom: 3,
                controls: ['zoomControl', 'typeSelector']
            });

            {% for log in logs %}
                {% if log[7] is not none and log[8] is not none %}
                    const placemark{{ loop.index }} = new ymaps.Placemark(
                        [{{ log[7] }}, {{ log[8] }}],
                        {
                            balloonContent: `
                                <div class="balloon-content">
                                    <b>üìÖ –î–∞—Ç–∞:</b> {{ log[9] }}<br>
                                    <b>üåê IP:</b> {{ log[2] }}<br>
                                    <b>üñ•Ô∏è –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</b> {{ log[4] }}<br>
                                    <b>üß≠ –ë—Ä–∞—É–∑–µ—Ä:</b> {{ log[5] }}
                                </div>
                            `
                        },
                        {
                            preset: 'islands#redIcon',
                            balloonCloseButton: true
                        }
                    );
                    map.geoObjects.add(placemark{{ loop.index }});
                {% endif %}
            {% endfor %}

            if (map.geoObjects.getLength() > 0) {
                map.setBounds(map.geoObjects.getBounds());
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
        }
    }
    </script>
</body>
</html>
